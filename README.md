# sf-b612-terraform-ansible
For Skill Factory study project (B6, Webinar practice)

<br>

### 00. Исходная задача (Задание 5 + Задание 6 + Дополнения)

* 5.1 Добавьте новых пользователей с авторизацией по ключу — Ansible роль "users" (создаются пользователи "user1", "user2")
* 5.2 Поднимите nginx server. Укажите в nginx отправлять php на 9000 порт» — Ansible роль "http" (имя роли изменено на "nginx")
* 5.3 Поднимите php-fpm. Укажите php-fpm принимать на 9000 порт — роль "php" (имя роли изменено на "phpfpm")
* 6.0 Поднимите nginx и php-fpm на разных серверах
* 6.1 Для nginx сервера используйте роли "users", "nginx"
* 6.2 Для php-fpm сервера используйте роли "users", "php"

* BONUS1: Создайте необходиме ресурсы с помощью Terrafrom
* BONUS2: Примените Ansible роли к создаваемым серверам прямо из Terraform конфигурации
* BONUS3: Напишите дополнительные инструментальные Ansible плейбуки для удаления установленного ПО и настроек с серверов

### 01. Предварительная нстройка среды окружения для Terraform и Ansible (указаны не все шаги)

```bash
1: сформируйте необходимые ssh ключевые пары доступные в текущем домашнем каталоге (см. main.tf для уточнения путей);
2. сгененируйте IAM токен для авторизации Terraform в облаке YandexCloud и поместите его в переменную окружения TF_VAR_yc_token
   $ export TF_VAR_yc_token=$(yc iam create-token) && echo $TF_VAR_yc_token
3. укажите необходиме идентификаторы облака в Terraform конфигурации "main.tf"
```

### 02. Создание облачных ресурсов с помощью Terraform и Ansible

```bash
..вариант 1: применяется Terraform конфигурация в результате чего получаем готовую облачную инфраструктуру
$ terraform validate
$ terraform plan
$ terraform apply

(i) в результате получаем следуюущий вывод (полное время создания и настройки облачных ресурсов около 17 минут)
    *ip адреса ресурсов будут отличаться в вашем случае

=OUTPUT:					
    Apply complete! Resources: 4 added, 0 changed, 0 destroyed.

    Outputs:

    vm1_nginx_external_ip = "ubuntu-nginx: 158.160.27.30"
    vm2_phpfpm_external_ip = "ubuntu-php-fpm: 158.160.19.88"
    webApp_url1_static = "http://158.160.27.30/cat.jpg"
    webApp_url2_dynamic = "http://158.160.27.30"
    webApp_url3_dynamic = "http://158.160.27.30/test.php"
    webApp_url4_dynamic = "http://158.160.27.30/info/"

$ terraform destroy     ## для удаления всех облачных ресурсов


..вариант 2: облачные ресурсы создаются отдельно (любым способом) и к ВМ применяются роли с помощью Ansible плейбуков
  *предположим ВМ у нас уже созданы в облаке и их публичные ip-адреса 158.160.27.30 (nginx хост), 158.160.19.88 (phpfpm хост)
  *применяем к каждой ВМ соотв. плейбуки
  *сначала настраивается phpfpm хост, затем nginx хост (при этом передается переменная содержащая публичный ip-адрес phpfpm хоста)

$ ansible-playbook -i 158.160.19.88, -u ubuntu ./ansible/deploy_phpfpm.yml
$ ansible-playbook -i 84.252.139.210, -u ubuntu -e host_public_ip_phpfpm=158.160.28.188 ./ansible/deploy_nginx.yml
```

### 03. Тестирование подключения к ВМ

```bash
..после успешного создания ВМ, к ним можно подключиться по ssh как с помощью встоенной учетной записи "ubuntu", так и с помощью созданных учетных записей
  *предположим ВМ у нас уже созданы в облаке и их публичные ip-адреса 158.160.27.30 (nginx хост), 158.160.19.88 (phpfpm хост)
  *в ~/.ssh/id_ed25519      - должен лежать приватный ssh ключ для основной учетной записи
  *в ~/.ssh/user/id_ed25519 - должен лежать приватный ssh ключ для учетных записей user1, user2 (используется 1 ключ для нескольких учеток)

$ ssh -i ~/.ssh/id_ed25519 ubuntu@158.160.27.30         ## ubuntu@nginx:~$ exit
$ ssh -i ~/.ssh/id_ed25519 ubuntu@158.160.19.88         ## ubuntu@phpfpm:~$ exit

$ ssh -i ~/.ssh/user/id_ed25519 user1@158.160.27.30     ## user1@nginx:~$ exit
$ ssh -i ~/.ssh/user/id_ed25519 user2@158.160.27.30		## user2@nginx:~$ exit

$ ssh -i ~/.ssh/user/id_ed25519 user1@158.160.19.88	    ## user1@phpfpm:~$ exit
$ ssh -i ~/.ssh/user/id_ed25519 user2@158.160.19.88	    ## user2@phpfpm:~$ exit
```

### 04. Проверка результата

```bash
..с помощью браузера на внешней рабочей станции, открываем указанные в результате применения Terraform конфигурации URL
  *ниже приведен примерный отображаемый в браузере результат, полный результат см. на прилагаемых скриншотах

http://158.160.27.30/cat.jpg        ## ..если увидели кота то все работает
http://158.160.27.30                ## It works! --- Server time: 2023-19-04 18:21:09
http://158.160.27.30/test.php       ## PHP Version 8.2.5
http://158.160.27.30/info/          ## SERVER_IP_ADDR....: 10.0.10.10
```

### 05. Примечание

```bash
1. В приведенной конфигурации Nginx хост подключается с помощью публичного ip-адреса к PHP-FPM хосту,
   что является работающим в данном случае решением, но не безопасным т.к оба хоста доступны по публичным адресам.
   Альтернативной конфигурацией может быть вариант когда PHP-FPM хост НЕ доступен извне, но доступен по локальному ip-адресу в локальной сети к которой подключены оба хоста.
   И в даном случае Nginx хост общается с PHP-FPM хостом по локальному адресу
2. Используемые образы Linux Ubuntu 22 достаточно тяжелые, в результате чего общее время развертывания инфраструктуры составляет около 17 минут.
   Если использовать более легкие Linux дистрибутивы, то возможно получиться сократить время развертывания, но потребует переписывания Ansible конфигурации
```

### 06. Результат применения IaC конфигурации к облаку YandexCloud

Скриншот0: созданные в YandexCloud ресурсы (виртуальные машины)
![screen](_screens/01_instances.png?raw=true)

Скриншот1: получение статического файла от веб-сервера nginx
![screen](_screens/02_instance1_nginx_staticFile.png?raw=true)

Скриншот2: результат выполнения php файла "index.php" на сервере phpfpm
![screen](_screens/03_instance1_nginx_phpResult1.png?raw=true)

Скриншот3: результат выполнения php файла "test.php" на сервере phpfpm
![screen](_screens/04_instance1_nginx_phpResult2.png?raw=true)

Скриншот4: результат выполнения php файла "info/index.php" на сервере phpfpm
![screen](_screens/05_instance1_nginx_phpResult3.png?raw=true)
